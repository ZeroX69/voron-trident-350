[probe_eddy_current fly_eddy_probe]
sensor_type: ldc1612
i2c_address: 43
i2c_mcu: SHT36
i2c_bus: i2c1e
x_offset: 0     # remember to set the x offset
y_offset: 21.42 # remember to set the y offset 
z_offset: 2     # remember to set the z offset
i2c_speed: 4000000

[temperature_probe fly_eddy_probe]
sensor_type: Generic 3950
sensor_pin:SHT36:gpio28
horizontal_move_z: 2

[force_move]
enable_force_move: true

[gcode_macro _LDC_CALIBRATE_DRIVE_CURRENT]
gcode:
    BED_MESH_CLEAR
    SET_KINEMATIC_POSITION x=100 y=100 z=10
    G28 X Y
    M104 S0
    M140 S0
    M106 S0
    G0 X{printer.toolhead.axis_maximum.x / 2} Y{printer.toolhead.axis_maximum.y / 2} F6000
    G0 Z30 F600
    G4 P1000
    LDC_CALIBRATE_DRIVE_CURRENT CHIP=fly_eddy_probe 
    G4 P1000
    SAVE_CONFIG

[gcode_macro PROBE_EDDY_CURRENT_CALIBRATE_AUTO]
gcode:
    BED_MESH_CLEAR
    G28 X Y
    M104 S0
    M140 S0
    M106 S0
    G90 # Abs positioning
    G1 X{ printer.toolhead.axis_maximum.x/2 } Y{ printer.toolhead.axis_maximum.y/2 } F6000
    {% if 'z' not in printer.toolhead.homed_axes %}
        SET_KINEMATIC_POSITION Z={ printer.toolhead.axis_maximum.z-1 } # Allows the user to work it down until it touches.
    {% endif %}
    PROBE_EDDY_CURRENT_CALIBRATE {rawparams}

[gcode_macro TEMP_COMPENSATION]
description: Temperature compensation calibration process
gcode:
    {% set bed_temp = params.BED_TEMP|default(90)|int %}
    {% set nozzle_temp = params.NOZZLE_TEMP|default(250)|int %}
    {% set temperature_range_value = params.TEMPERATURE_RANGE_VALUE|default(3)|int %}
    {% set desired_temperature = params.DESIRED_TEMPERATURE|default(80)|int %}
    {% set Temperature_Timeout_Duration = params.TEMPERATURE_TIMEOUT_DURATION|default(6500000000)|int %}
        # Safety check: Ensure all axes are not locked
        {% if printer.pause_resume.is_paused %}
            { action_raise_error("Error: Printer is paused, please resume first") }
        {% endif %}
        # Step 1: Home all axes
        STATUS_MESSAGE="Homing all axes..."
        G28
        STATUS_MESSAGE="Homing complete"
        # Step 2: Automatic leveling
        #Z_TILT_ADJUST
        #quad_gantry_level
        # Step 3: Safe Z-axis lift
        STATUS_MESSAGE="Lifting Z-axis..."
        G90
        G0 Z5 F2000  # Lift slowly to prevent collisions
        # Step 4: Set timeout and temperature calibration
        SET_IDLE_TIMEOUT TIMEOUT={Temperature_Timeout_Duration}
        STATUS_MESSAGE="Starting temperature probe calibration..."
        TEMPERATURE_PROBE_CALIBRATE PROBE=fly_eddy_probe TARGET={desired_temperature} STEP={temperature_range_value}
        # Step 5: Set printing temperatures (modify as needed)
        STATUS_MESSAGE="Setting working temperatures..."
        SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={bed_temp}
        SET_HEATER_TEMPERATURE HEATER=extruder TARGET={nozzle_temp}
        # Completion message
        STATUS_MESSAGE="Temperature compensation process completed!"
        # description: G-Code macro

[gcode_macro Z_TILT_ADJUST]
rename_existing: _Z_TILT_ADJUST
gcode:
    {% set PROBE_Z_OFFSET = printer.configfile.settings['probe_eddy_current fly_eddy_probe'].z_offset|float %}
    # ========== State Save ==========
    SAVE_GCODE_STATE NAME=STATE_Z_TILT
    
    # ========== Environment Preparation ==========
    BED_MESH_CLEAR                       # Clear existing bed mesh data 
    
    # ========== Main Leveling Process ==========
    {% if not printer.z_tilt.applied %}
        # Initial coarse adjustment 
        _Z_TILT_ADJUST horizontal_move_z=10 retry_tolerance=1
    {% endif %}
    
    # Fine secondary leveling 
    _Z_TILT_ADJUST horizontal_move_z={PROBE_Z_OFFSET} retry_tolerance=0.075 retries=20 METHOD=rapid_scan ADAPTIVE=1
        G0 Z10 F6000                     # Use standard G-code commands instead of HORIZONTAL_MOVE_Z

    # ========== Post-Processing ==========
    G90                                 # Force absolute coordinate mode 
    G0 Z10 F6000                        # Raise Z axis to safe height 
    M117 Z_tilt Completed               # Display completion status 
    #G28                                 # Return to origin
    # ========== State Restore ==========
    RESTORE_GCODE_STATE NAME=STATE_Z_TILT
    M400    

[gcode_macro BED_MESH_CALIBRATE]
rename_existing: _BED_MESH_CALIBRATE
gcode:
    {% set PROBE_Z_OFFSET = printer.configfile.settings['probe_eddy_current fly_eddy_probe'].z_offset|float %}
    {% set TARGET_TEMP = printer.heater_bed.target %}
    M140 S0
    _BED_MESH_CALIBRATE horizontal_move_z={PROBE_Z_OFFSET} METHOD=rapid_scan {rawparams}
    M140 S{TARGET_TEMP}

[save_variables]
filename: ~/printer_data/config/variables.cfg